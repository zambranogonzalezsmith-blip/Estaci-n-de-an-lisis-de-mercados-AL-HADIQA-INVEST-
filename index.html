<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALHADIQA | Institutional Terminal v4.5</title>
    
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    
    <style>
        /* --- CSS MAESTRO: STEALTH DESIGN --- */
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600&display=swap');

        :root {
            --bg-main: #050608;
            --bg-sidebar: #0a0c12;
            --bg-card: rgba(22, 25, 37, 0.8);
            --border: rgba(31, 209, 237, 0.15);
            --accent: #1fd1ed;
            --gold: #d29922;
            --success: #00ff9d;
            --danger: #ff4a4a;
            --text-main: #e2e8f0;
            --text-dim: #64748b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* Top Bar Fix */
        .top-bar {
            height: 50px;
            background: var(--bg-sidebar);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 1100;
        }

        #menu-toggle {
            background: none; border: 1px solid var(--accent);
            color: var(--accent); padding: 5px 12px;
            font-family: 'JetBrains Mono'; cursor: pointer; font-size: 11px;
        }

        /* Layout Din√°mico */
        .dashboard-wrapper {
            display: flex; flex: 1; position: relative; overflow: hidden;
        }

        .sidebar {
            width: 260px; height: 100%;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            transition: transform 0.3s ease;
            z-index: 1000; padding: 20px;
        }

        .menu-collapsed .sidebar { transform: translateX(-100%); position: absolute; }

        .main-content {
            flex: 1; display: flex; flex-direction: column; min-width: 0;
        }

        .content-grid {
            display: grid; grid-template-columns: 1fr 320px; height: 100%;
        }

        /* EL FIX DEL GR√ÅFICO: Contenedor absoluto */
        .chart-area {
            position: relative; background: #000; border-right: 1px solid var(--border);
            overflow: hidden; width: 100%; height: 100%;
        }

        #main-chart {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        }

        .info-panel {
            background: var(--bg-main); padding: 15px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 12px;
        }

        /* Cards y Botones */
        .card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 8px; padding: 15px; backdrop-filter: blur(10px);
        }

        .kira-panel { border-top: 2px solid var(--gold); }
        .highlight { color: var(--accent); font-family: 'JetBrains Mono'; font-size: 1.2rem; }
        
        .tf-selector { display: flex; gap: 5px; margin-bottom: 10px; }
        .tf-btn { 
            flex: 1; background: #1a1e2e; border: 1px solid var(--border); 
            color: var(--text-dim); padding: 6px; cursor: pointer; font-size: 10px;
        }
        .tf-btn.active { background: var(--accent); color: #000; font-weight: bold; }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center;
        }
        .payment-card {
            background: #0d1117; border: 1px solid var(--gold);
            padding: 30px; text-align: center; border-radius: 4px; width: 350px;
        }
    </style>
</head>
<body class="menu-collapsed">

    <nav class="top-bar">
        <button id="menu-toggle" onclick="toggleMenu()">ROOT@ALHADIQA:~$ MENU</button>
        <div style="font-family: 'JetBrains Mono'; font-size: 12px;">
            <span id="digital-clock">00:00:00</span> UTC
        </div>
    </nav>

    <div class="dashboard-wrapper">
        <aside class="sidebar">
            <div style="margin-bottom: 20px;">
                <h2 style="color:var(--accent); font-size: 18px;">ALHADIQA</h2>
                <small style="color:var(--gold); letter-spacing: 2px;">QUANT DESK</small>
            </div>
            <nav style="display: flex; flex-direction: column; gap: 10px;">
                <a href="#" style="color:white; text-decoration:none;">üìà TERMINAL</a>
                <a href="#" onclick="abrirPasarela()" style="color:var(--text-dim); text-decoration:none;">üí≥ KIRA PAY</a>
                <a href="#" onclick="alert('Diagn√≥stico: Latencia 24ms')" style="color:var(--text-dim); text-decoration:none;">üîç DIAGNOSTIC</a>
            </nav>
        </aside>

        <main class="main-content">
            <div class="content-grid">
                <section class="chart-area">
                    <div id="main-chart"></div>
                </section>

                <aside class="info-panel">
                    <div class="card kira-panel">
                        <small style="color:var(--gold)">KIRA_ENGINE_v4.5</small>
                        <div id="kira-signal-box" style="margin: 10px 0; padding: 10px; border-left: 3px solid var(--accent);">
                            <span id="kira-action" style="font-family:'JetBrains Mono';">SCANNING...</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <div><small>LOT</small><br><span id="suggested-lot" class="highlight">0.01</span></div>
                            <div><small>RSI</small><br><span id="rsi-value" class="highlight">--</span></div>
                        </div>
                    </div>

                    <div class="card">
                        <label style="font-size: 10px; color: var(--text-dim);">TIMEFRAME</label>
                        <div class="tf-selector">
                            <button class="tf-btn" onclick="cambiarTF('1m')">1M</button>
                            <button class="tf-btn active" onclick="cambiarTF('15m')">15M</button>
                            <button class="tf-btn" onclick="cambiarTF('1h')">1H</button>
                        </div>
                        <select id="asset-selector" onchange="cargarActivo()" style="width: 100%; background: #000; color: white; border: 1px solid var(--border); padding: 8px;">
                            <option value="BTC">BTC / USDT</option>
                            <option value="ETH">ETH / USDT</option>
                        </select>
                    </div>

                    <div class="card" style="flex: 1;">
                        <h3 id="current-price" style="font-size: 24px; color: var(--accent);">$0.00</h3>
                        <small id="asset-name" style="color: var(--text-dim);">BITCOIN</small>
                    </div>
                </aside>
            </div>
        </main>
    </div>

    <div id="crypto-modal" class="modal-overlay">
        <div class="payment-card">
            <h3 style="color:var(--gold)">KIRA_PAY_GATEWAY</h3>
            <div style="background: white; padding: 10px; margin: 20px auto; width: 170px;">
                <img id="qr-deposit" src="" style="width: 150px;">
            </div>
            <code id="wallet-addr" style="font-size: 10px; color: var(--accent); display: block; margin-bottom: 20px;">0x3D88C...</code>
            <button onclick="cerrarPasarela()" style="background: var(--danger); border: none; padding: 10px; color: white; cursor: pointer; width: 100%;">CERRAR</button>
        </div>
    </div>

    <script>
        // --- JS MOTOR DE RENDERIZADO CORREGIDO ---
        let chart, candleSeries, currentSocket;
        let GLOBAL = { asset: 'BTC', tf: '15m', map: { 'BTC': 'btcusdt', 'ETH': 'ethusdt' } };

        function initTerminal() {
            const container = document.getElementById('main-chart');
            if (!container) return;

            // Limpieza preventiva
            container.innerHTML = '';
            
            chart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: container.clientHeight,
                layout: { background: { color: '#000000' }, textColor: '#7982a9' },
                grid: { vertLines: { color: '#0f111a' }, horzLines: { color: '#0f111a' } },
                timeScale: { borderColor: '#1f2335', timeVisible: true }
            });

            candleSeries = chart.addCandlestickSeries({
                upColor: '#00ff9d', downColor: '#ff4a4a', 
                borderVisible: false, wickUpColor: '#00ff9d', wickDownColor: '#ff4a4a'
            });

            window.addEventListener('resize', () => {
                chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
            });

            cargarActivo();
        }

        async function cargarActivo() {
            const symbol = GLOBAL.map[document.getElementById('asset-selector').value];
            if (currentSocket) currentSocket.close();

            // Fetch Historia
            const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol.toUpperCase()}&interval=${GLOBAL.tf}&limit=200`);
            const data = await res.json();
            const initialData = data.map(d => ({
                time: d[0] / 1000, open: parseFloat(d[1]), high: parseFloat(d[2]), low: parseFloat(d[3]), close: parseFloat(d[4])
            }));
            candleSeries.setData(initialData);

            // Socket Realtime
            currentSocket = new WebSocket(`wss://stream.binance.com:9443/ws/${symbol}@kline_${GLOBAL.tf}`);
            currentSocket.onmessage = (msg) => {
                const k = JSON.parse(msg.data).k;
                const candle = { time: k.t / 1000, open: parseFloat(k.o), high: parseFloat(k.h), low: parseFloat(k.l), close: parseFloat(k.c) };
                candleSeries.update(candle);
                document.getElementById('current-price').innerText = `$${candle.close.toFixed(2)}`;
            };
        }

        function cambiarTF(tf) {
            GLOBAL.tf = tf;
            document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            cargarActivo();
        }

        function toggleMenu() {
            document.body.classList.toggle('menu-collapsed');
            setTimeout(() => {
                const container = document.getElementById('main-chart');
                chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
            }, 300);
        }

        function abrirPasarela() {
            const wallet = "0x3D88C06C786a3449377708705F6fE6306c368686";
            document.getElementById('crypto-modal').style.display = 'flex';
            document.getElementById('qr-deposit').src = `https://api.qrserver.com/v1/create-qr-code/?data=${wallet}`;
            document.getElementById('wallet-addr').innerText = wallet;
        }
        function cerrarPasarela() { document.getElementById('crypto-modal').style.display = 'none'; }

        // Boot
        window.onload = () => {
            initTerminal();
            setInterval(() => {
                document.getElementById('digital-clock').innerText = new Date().toLocaleTimeString('en-GB', {timeZone:'UTC'});
            }, 1000);
        };
    </script>
</body>
</html>
